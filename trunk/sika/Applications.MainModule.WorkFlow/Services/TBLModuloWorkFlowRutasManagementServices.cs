//------------------------------------------------------------------------------
// <auto-generated>
//     Este codigo fue generado por el motor de generacion de codigo de propiedad de Walter molano.
//     El cambio  de algunas lineas de codigo podran causar comportamientos
//     inesperados de la aplicacion.  junio 18 de 2014.
// </auto-generated>
//------------------------------------------------------------------------------

#pragma warning disable 1591 // this is for supress no xml comments in public members warnings 
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text.RegularExpressions;
using System.Transactions;
using Application.MainModule.SqlServices.IServices;
using Applications.MainModule.SystemActions.Service;
using Applications.MainModule.WorkFlow.DTO;
using Applications.MainModule.WorkFlow.IServices;
using Applications.MainModule.WorkFlow.Resources;
using Applications.MainModule.WorkFlow.Util;
using Domain.MainModule.Contracts;
using Domain.MainModule.Documentos.Contracts;
using Domain.MainModule.WorkFlow.Contracts;
using Domain.MainModule.WorkFlow.Enums;
using Domain.MainModule.WorkFlow.Services.FieldsValidatos;
using Domain.MainModule.WorkFlow.Services.WorkFlow;
using Domain.MainModules.Entities;
using Domain.Core.Specification;
using Infraestructure.CrossCutting.Security.IServices;
using Infrastructure.CrossCutting.NetFramework.Enums;
using IsolationLevel = System.Transactions.IsolationLevel;

namespace Applications.MainModule.WorkFlow.Services
{
    public class SfTBL_ModuloWorkFlow_RutasManagementServices : ISfTBL_ModuloWorkFlow_RutasManagementServices
    {

        #region Fields
        private readonly ITBL_ModuloWorkFlow_RutasRepository _tblModuloWorkFlowRutasRepository;
        private readonly ITBL_ModuloDocumentos_DocumentoRepository _tblDocumentosRepository;
        private readonly IPedidosEmpacorServices _sqlPedidosServices;
        private readonly ITBL_Admin_EstadosProcesoRepository _estadosRepository;
        private readonly ITblModuloWorkFlowRutasFieldsValidatorDomainServices _workFlowDomainFieldsValidatorServices;
        private readonly ITblModuloWorkFlowRutaDomainServices _workFlowDomainServices;
        private readonly ISystemActionsManagementServices _systemActionsServices;
        private readonly IAutentication _autenticationService;
        private readonly ITBL_ModuloDocumentos_LogCambiosRepository _logDocumentosRepository;
        private readonly ITBL_Admin_UsuariosRepository _usuariosRepository;
        private readonly ITBL_Admin_SistemaNotificacionesRepository _notificacionesSistemaRepository;
        private readonly ISendMailNotification _sendMailNotificationServices;
        #endregion

         #region Constructor
         /// <summary>
         /// Constructor de la Calse 
         /// </summary>
         public SfTBL_ModuloWorkFlow_RutasManagementServices( 
             ITBL_ModuloWorkFlow_RutasRepository tblModuloWorkFlowRutasRepository, 
             IPedidosEmpacorServices sqlPedidosServices, 
             ITBL_Admin_EstadosProcesoRepository estadosRepository,
             ITblModuloWorkFlowRutasFieldsValidatorDomainServices workFlowDomainFieldsValidatorServices, 
             ITblModuloWorkFlowRutaDomainServices workFlowDomainServices, 
             ISystemActionsManagementServices systemActionsServices, 
             IAutentication autenticationService, 
             ITBL_Admin_UsuariosRepository usuariosRepository, 
             ITBL_Admin_SistemaNotificacionesRepository notificacionesSistemaRepository, 
             ISendMailNotification sendMailNotificationServices, ITBL_ModuloDocumentos_DocumentoRepository tblDocumentosRepository, ITBL_ModuloDocumentos_LogCambiosRepository logDocumentosRepository)
         {
            if (tblModuloWorkFlowRutasRepository == null)
                throw new ArgumentNullException("tblModuloWorkFlowRutasRepository");
            _tblModuloWorkFlowRutasRepository = tblModuloWorkFlowRutasRepository;
             _logDocumentosRepository = logDocumentosRepository;
             _tblDocumentosRepository = tblDocumentosRepository;
             _sendMailNotificationServices = sendMailNotificationServices;
             _notificacionesSistemaRepository = notificacionesSistemaRepository;
             _usuariosRepository = usuariosRepository;
             _autenticationService = autenticationService;
             _systemActionsServices = systemActionsServices;
             _workFlowDomainServices = workFlowDomainServices;
             _workFlowDomainFieldsValidatorServices = workFlowDomainFieldsValidatorServices;
             _estadosRepository = estadosRepository;
             _sqlPedidosServices = sqlPedidosServices;

         }
         #endregion

         #region Members Work Flow
         /// <summary>
         /// Crea una nueva instancia de la entidad 
         /// </summary>
         public TBL_ModuloWorkFlow_Rutas NewEntity()
         {
            return new TBL_ModuloWorkFlow_Rutas();
         }

         /// <summary>
         /// Inserta un nuevo registro en la Base de Datos.
         /// </summary>
         public void Add(TBL_ModuloWorkFlow_Rutas entity)
         {
            //Begin unit of work ( if Transaction is required init here a new TransactionScope element
            var unitOfWork = _tblModuloWorkFlowRutasRepository.UnitOfWork;
            _tblModuloWorkFlowRutasRepository.Add(entity);
            //Complete changes in this unit of work
            unitOfWork.Commit();
         }

          /// <summary>
          /// Actualiza el registro en la Base de Datos.
          /// </summary>
         public void Modify(TBL_ModuloWorkFlow_Rutas entity)
         {
            if (entity == null)
                throw new ArgumentNullException(string.Format("Modificar : El objeto esta nulo."));

            var unitOfWork = _tblModuloWorkFlowRutasRepository.UnitOfWork;
            _tblModuloWorkFlowRutasRepository.Modify(entity);
            unitOfWork.CommitAndRefreshChanges();
         }

          /// <summary>
          /// Elimina el registro en la Base de Datos.
          /// </summary>
         public void Remove(TBL_ModuloWorkFlow_Rutas entity)
         {
            if (entity == null)
                throw new ArgumentNullException(string.Format("Eliminar : El objeto esta nulo."));

            //Begin unit of work ( if Transaction is required init here a new TransactionScope element
            var unitOfWork = _tblModuloWorkFlowRutasRepository.UnitOfWork;

            _tblModuloWorkFlowRutasRepository.Remove(entity);

            //Complete changes in this unit of work
            unitOfWork.CommitAndRefreshChanges();
         }

          /// <summary>
          /// Obtiene una Ãºnica entidad filtrada por ID.
          /// </summary>
         public TBL_ModuloWorkFlow_Rutas FindById(int id)
         {
            if (id == 0)
                throw new ArgumentNullException(string.Format("Busqueda por Id : El parametro es nulo."));

            Specification<TBL_ModuloWorkFlow_Rutas> specification = new DirectSpecification<TBL_ModuloWorkFlow_Rutas>(u => u.IdRuta == id);

            return _tblModuloWorkFlowRutasRepository.GetEntityBySpec(specification);
           
         }
	

          /// <summary>
          /// Obtiene el listado de entidades activas.
          /// </summary>
         public List<TBL_ModuloWorkFlow_Rutas> FindBySpec(bool isActive)
         {
            Specification<TBL_ModuloWorkFlow_Rutas> specification = new DirectSpecification<TBL_ModuloWorkFlow_Rutas>(u => u.IsActive == isActive);
            return _tblModuloWorkFlowRutasRepository.GetBySpec(specification).ToList();
         }

          /// <summary>
          /// Obtiene el listado de entidades activas y paginadas.
          /// </summary>
         public List<TBL_ModuloWorkFlow_Rutas> FindPaged(int pageIndex, int pageCount)
         {
            if (pageIndex < 0)
                throw new ArgumentException(Resources.Messages.exception_InvalidPageIndex, "pageIndex");

            if (pageCount <= 0)
                throw new ArgumentException(Resources.Messages.exception_InvalidPageCount, "pageCount");


            Specification<TBL_ModuloWorkFlow_Rutas> onlyEnabledSpec = new DirectSpecification<TBL_ModuloWorkFlow_Rutas>(u => u.IsActive);

            return _tblModuloWorkFlowRutasRepository.GetPagedElements(pageIndex, pageCount, u => u.IdRuta, onlyEnabledSpec, true).ToList();
         }

         public IEnumerable<TBL_ModuloWorkFlow_Rutas> ListadoRutasPorIdModule(ModulosAplicacion  module)
         {
             var strModule = module.ToString();
             var specification = new DirectSpecification<TBL_ModuloWorkFlow_Rutas>(u => u.IsActive && u.TipoModulo.Equals(strModule));
             return _tblModuloWorkFlowRutasRepository.FindRutasBySpec(specification).ToList();
         }

         public List<TBL_ModuloWorkFlow_Rutas> FindBySpec(int idRuta)
         {
             Specification<TBL_ModuloWorkFlow_Rutas> specification = new DirectSpecification<TBL_ModuloWorkFlow_Rutas>(u => u.IdRuta == idRuta);
             return _tblModuloWorkFlowRutasRepository.FindRutasBySpec(specification).ToList();
         }


         public List<TBL_ModuloWorkFlow_Rutas> GetRutasByEstadoByModule(int idEstadoDocumento, ModulosAplicacion module)
         {
             var strModule = module.ToString();
             var specification =
                 new DirectSpecification<TBL_ModuloWorkFlow_Rutas>(
                     u => u.IsActive && u.IdEstado == idEstadoDocumento && u.TipoModulo.Equals(strModule));
             return _tblModuloWorkFlowRutasRepository.FindRutasBySpec(specification).OrderBy(x=> x.Secuencia).ToList();

         }


        #endregion

         #region Members Pedidos

        private DataTable GetPedidoWorkFlowByIdPedido(string idPedido)
        {
            return _sqlPedidosServices.GetPedidoWorkFlowByIdPedido(idPedido);
        }
         #endregion

       
        /// <summary>
        /// Carga los parametros iniciales aplicando las reglas de validaciÃ³nn definidas en las rutas.
        /// </summary>
        /// <param name="idPedido"></param>
        /// <returns></returns>
        public RenderTypeControlButtonDto CargarWorkFlow(string idPedido)
        {

            try
            {

                var estadoPedido = _sqlPedidosServices.EstadoPedido(idPedido);

                if (string.IsNullOrEmpty(estadoPedido))
                    throw new Exception("Error al obtener el estado del pedido desde la Base de Datos.");

                var dtPedido = GetPedidoWorkFlowByIdPedido(idPedido);

                var listadoRutas = GetRutasByEstadoByModule(Convert.ToInt32(estadoPedido), ModulosAplicacion.Pedidos);

                var oWorkflow = _workFlowDomainServices.CargarWorkFlow(listadoRutas, dtPedido);

                if (oWorkflow == null) return null;

                var responsable = RetornarUsuarioResponsable(oWorkflow.CurrenteResponsible, Convert.ToInt32(idPedido), dtPedido);

                var oRender = new RenderTypeControlButtonDto
                                  {
                                      CurrentStatus = oWorkflow.CurrentStatus,
                                      IdCurrentStatus = estadoPedido,
                                      NextStatus = oWorkflow.NextStatus,
                                      IdNextStatus = oWorkflow.IdNextStatus,
                                      TextControl = oWorkflow.TextControl,
                                      IdDocument = idPedido,
                                      CurrentResponsibe = responsable.Nombres,
                                      IdCurrentResponsibe = responsable.IdUser.ToString(),
                                      EmailCurrentResponsibe = responsable.Email
                };

                return oRender;
            }
            catch (Exception ex)
            {
                throw new Exception("CargarWorkFlow", ex);
            }
        }

        /// <summary>
        /// Ejecuta el WorkFlow realizando validaciones y dependiendo del resultado de las mismas, se actualiza  o no el pedido.
        /// </summary>
        /// <param name="oDocument"></param>
        /// <returns></returns>
        public RenderTypeControlButtonDto EjecutarWorkFlow(RenderTypeControlButtonDto oDocument)
        {
            try
            {


                if (oDocument == null) return null;

                var oEstado = _estadosRepository.GetEstadoById(Convert.ToInt32(oDocument.IdCurrentStatus));

                if (oEstado == null)
                    throw new ArgumentException(string.Format("Error al recuperar el estado {0} desde la Base de Datos.", oDocument.CurrentStatus));

                var oDocumento = _tblDocumentosRepository.GetDocumentoById(Convert.ToInt32(oDocument.IdDocument));

                if (oDocumento == null)
                    throw new ArgumentException(string.Format("Error al recuperar el pedido {0} desde la Base de Datos.", oDocument.IdDocument));

                var nextStatus = Convert.ToInt32(oDocument.IdNextStatus);
                var currentRule = oEstado.TBL_ModuloWorkFlow_Rutas.Where(x => x.SiguienteEstado == nextStatus).SingleOrDefault();

                if (currentRule.ValidaRequeridos)
                {
                    if (oEstado.TBL_ModuloWorkFlow_CamposValidacion.Count > 0)
                    {
                        var result = ValidacionDeCampos(oEstado, oDocumento, oDocument);
                        if (!result)
                        {
                            oDocument.ProcessStatus = ProcessStatus.ValidationErrorField;
                            return oDocument;
                        }
                    }
                    else
                    {
                        var mensaje = string.Format(Messages.NotFieldValidations, currentRule.IdRuta, currentRule.IdEstado);
                        oDocument.MessagesError.Add(mensaje);
                    }
                }

                if (currentRule.TBL_ModuloWorkFlow_ValidacionesSalida.Count > 0)
                {

                    var inputParameters = currentRule.TBL_ModuloWorkFlow_ValidacionesSalida.Where(
                            x => x.NombreMetodo.Contains("[InputParameters]"));

                    if (inputParameters.Count() > 0)
                    {
                        //Los parametros de entrada rompen el flujo de la aplicaciÃ³n para lanzar ventanas de captura y proceguir con el flujo 
                        //desde otro formulario.
                        ProcesarParametrosEntrada(oDocument, currentRule.TBL_ModuloWorkFlow_ValidacionesSalida);
                        oDocument.ProcessStatus = ProcessStatus.InputParameters;
                        return oDocument;
                    }

                    var listerror = EjecutarAccionSistema(currentRule.TBL_ModuloWorkFlow_ValidacionesSalida,oDocumento.IdDocumento);
                    if (listerror.Count > 0)
                    {
                        foreach (var msg in listerror)
                        {
                            oDocument.MessagesError.Add(msg);
                        }
                        oDocument.ProcessStatus = ProcessStatus.ValidationErrorSystemActions;
                        return oDocument;
                    }
                }

                

                var txSettings = new TransactionOptions()
                {
                    Timeout = TransactionManager.DefaultTimeout,
                    IsolationLevel = IsolationLevel.Serializable
                };

                using (var scope = new TransactionScope(TransactionScopeOption.Required, txSettings))
                {
                    var unitOfWork = _tblDocumentosRepository.UnitOfWork;

                    oDocumento.IdEstado = Convert.ToInt32(oDocument.IdNextStatus);

                    oDocumento.ModifiedBy = _autenticationService.GetUserFromSession.IdUser;

                    oDocumento.ModifiedOn = DateTime.Now;

                    if (!string.IsNullOrEmpty(oDocument.IdCurrentResponsibe))
                        oDocumento.IdUsuarioResponsable = Convert.ToInt32(oDocument.IdCurrentResponsibe);

                    _tblDocumentosRepository.Modify(oDocumento);

                    //Crea un nuevo registro en el tracking del pedido
                    GenerarEntradatracking(oDocument);

                    //Crea un nuevo registro en el log del pedido.
                    GenerarEntradalogPedido(oDocument);

                    GenerarNotificacionSistema(oDocument);

                    unitOfWork.CommitAndRefreshChanges();

                    oDocument.ProcessStatus = ProcessStatus.Ok;
                    
                    SendMail(oDocument);

                    scope.Complete();
                }

                return oDocument;

            }
            catch (Exception ex)
            {
                throw new Exception("EjecutarWorkFlow", ex);
            }
        }

        
        /// <summary>
        /// Realiza el proceso de validaciÃ³n de campos con base a las reglas definidas en la tabla FieldValidations.
        /// </summary>
        /// <param name="oEstado"></param>
        /// <param name="oDocumento"></param>
        /// <param name="oDocument"></param>
        /// <returns></returns>
        private bool ValidacionDeCampos(TBL_Admin_EstadosProceso oEstado, TBL_ModuloDocumentos_Documento oDocumento, RenderTypeControlButtonDto oDocument)
        {
            var isValidFields = _workFlowDomainFieldsValidatorServices.IsValidField(oDocumento, oEstado);
            if (!isValidFields)
            {
                var listErrors = _workFlowDomainFieldsValidatorServices.GetValidationErrorsMessages;

                var procedimientos = _workFlowDomainFieldsValidatorServices.GetStoreProceduresValidadtionFunctions;
                if (procedimientos.Count > 0)
                {
                    listErrors.AddRange(from procedimiento in procedimientos
                                        let result = EjecutarSp(procedimiento)
                                        where !result
                                        select string.Format("SP:[{0}] - Mensaje:[{1}]", procedimiento, "La validaciÃ³n a travÃ©z de la funciÃ³n externa no fue exitosa!!."));
                }

                oDocument.MessagesError = listErrors;
            }

            return isValidFields;
        }
       
        /// <summary>
        /// FunciÃ³n que ejecuta procedimientos almacenados con AdoNet
        /// </summary>
        /// <param name="sp"></param>
        /// <returns></returns>
        private bool EjecutarSp(string sp)
        {
            var result = _sqlPedidosServices.VerificarSuministros(sp);
            return Convert.ToBoolean(result);
        }

        /// <summary>
        /// El parÃ¡metro mÃ­nimo que de debe enviar al servicio de ejecuciÃ³n de funciones del sistema debe ser el Id del Documento
        /// Si por alguna razÃ³n es necesario algun parÃ¡metro adicional, se deberÃ¡n implemetar las reglas de negocio dentro de la clase
        /// que invoca el mÃ©todo que realiza la validaciÃ³n. 
        /// 
        /// </summary>
        /// <param name="accionesSistema"></param>
        /// <param name="idPedido"></param>
        /// <returns></returns>
        private List<string> EjecutarAccionSistema(IEnumerable<TBL_ModuloWorkFlow_ValidacionesSalida> accionesSistema, int idPedido)
        {
            try
            {
                var messages = new List<string>();
                foreach (var salida in accionesSistema)
                {


                    _systemActionsServices.AssemblyQualifiedName = salida.NombreEnsamblado;
                    _systemActionsServices.MethodName = salida.NombreMetodo;
                    _systemActionsServices.Params = new object[]{idPedido};

                    var result = _systemActionsServices.Execute();

                    if(result is bool)
                    {
                        if(!Convert.ToBoolean(result))
                            messages.Add(string.Format("La EjecuciÃ³n de la AcciÃ³n del Sistema [{0}] retornÃ³ FALSO en el proceso de validaciÃ³n..", salida.NombreMetodo));
                    }
                }

                return messages;
            }
            catch (Exception ex)
            {
                throw new Exception("EjecutarAccionSistema", ex);
            }
        }

        /// <summary>
        /// Recoge en una lista el nombre de las funciones que se deben ejecutar como una ventana de mensaje desde la interface grafica.
        /// </summary>
        /// <param name="oDocument"></param>
        /// <param name="ovalidaciones"></param>
        private static void ProcesarParametrosEntrada(RenderTypeControlButtonDto oDocument, IEnumerable<TBL_ModuloWorkFlow_ValidacionesSalida> ovalidaciones)
        {
            var subjectRegex = new Regex(@"\[InputParameters\](.*)\[\/InputParameters\]", RegexOptions.Compiled | RegexOptions.Singleline);
            var inputList = new List<string>();
            foreach (var input in
                ovalidaciones.Select(val => subjectRegex.Match(val.NombreMetodo).Groups[1].Value).Where(input => !string.IsNullOrEmpty(input)))
            {
                if(input.Contains(":"))
                {
                    var nameFunctions = input.Split(':');
                    inputList.AddRange(nameFunctions);
                }
                else
                {
                    inputList.Add(input);
                }

                oDocument.OutputParameters = inputList;
            }
        }

        /// <summary>
        /// Evalua la expresiÃ³n retornando el nombre del usuario responsable  como producto de la verificaciÃ³n
        /// </summary>
        /// <param name="role"></param>
        /// <param name="idPedido"></param>
        /// <param name="dt"></param>
        /// <returns></returns>
        private TBL_Admin_Usuarios RetornarUsuarioResponsable(string role, int idPedido, DataTable dt)
        {
            var roleResponsable = role;
            if(role.Contains("[Fn]") )
            {
                roleResponsable = _workFlowDomainServices.MapearExpresion(role, dt); 
            }

            if(roleResponsable.Contains("Aut"))
            {
                var user = _usuariosRepository.RetornarUsuarioAutordocumento(idPedido);
                if (user != null)
                {
                    return user;
                }
            }
            var userrole = _usuariosRepository.RetornarUsuarioReponsableAprobacion(roleResponsable);

            return userrole;
        }

        /// <summary>
        /// Crea un nuevo registro en el trackin del pedido
        /// </summary>
        /// <param name="oDocument"></param>
        private void GenerarEntradatracking(RenderTypeControlButtonDto oDocument)
        {
          
           //var oTrack = _pedidosDomainServices.GenerarObjetoTrackpedido(_trackinRepository.NewEntity(), oDocument.TextControl,
           //                                                 oDocument.CurrentStatus,
           //                                                 Convert.ToInt32(oDocument.IdDocument), oDocument.NextStatus,
           //                                                 oDocument.CurrentResponsibe);
           // _trackinRepository.Add(oTrack);
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="oDocument"></param>
        private void GenerarEntradalogPedido(RenderTypeControlButtonDto oDocument)
        {
            //var oLog = _pedidosDomainServices.GenerarObjetoLogPedido(_logDocumentosRepository.NewEntity(),
            //                                                         oDocument.TextControl,
            //                                                         Convert.ToInt32(oDocument.IdDocument));
            //_logDocumentosRepository.Add(oLog);
        }

        /// <summary>
        /// EnvÃ­a una notificaciÃ³n al responsable del documento al correo electronico.
        /// </summary>
        /// <param name="oDocument"></param>
        /// <returns></returns>
        private bool SendMail(RenderTypeControlButtonDto oDocument)
        {
            return _sendMailNotificationServices.EnviarCorreoElectronicoNotificacion(oDocument);
        }

        /// <summary>
        /// Crea un nuevo registro en la tabla de notificaciones para el usuario responsable del documento.
        /// </summary>
        private void GenerarNotificacionSistema(RenderTypeControlButtonDto oDocument)
        {
            var template = _sendMailNotificationServices.GetMergeTemplate(oDocument);
            if(template == null)return;

            var cliente = _sqlPedidosServices.RetornarNombreClienteByIdPedido(oDocument.IdDocument);

            //var oNotify = _pedidosDomainServices.GenerarEntradaNotificadorSistema(
            //                           _notificacionesSistemaRepository.NewEntity(),
            //                           Convert.ToInt32(oDocument.IdCurrentResponsibe),
            //                           template, cliente);

            //_notificacionesSistemaRepository.Add(oNotify);
        }


        #region IDisposable Members

        /// <summary>
        /// Release all resources
        /// </summary>
        public void Dispose()
        {
            //release used unit of work
            //if you have many repositories but  lifetime is per resolve only need
            //dispose one

            if (_tblModuloWorkFlowRutasRepository != null)
            {
                _tblModuloWorkFlowRutasRepository.UnitOfWork.Dispose();
            }
        }

        #endregion
    }
}
    